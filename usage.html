
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Usage &#8212; Namazu 0.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=2709fde1"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'usage';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Build instructions" href="BuildInstructions.html" />
    <link rel="prev" title="Welcome to Namazu’s documentation!" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/LogoSmall.png" class="logo__image only-light" alt="Namazu 0.1 documentation - Home"/>
    <script>document.write(`<img src="_static/LogoSmall.png" class="logo__image only-dark" alt="Namazu 0.1 documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="#">
    Usage
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="BuildInstructions.html">
    Build instructions
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="mathBackground.html">
    Mathematical Background
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="hardware.html">
    Hardware
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="functionality.html">
    Functionality
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="microcontroller.html">
    Microcontroller
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="misc.html">
    Miscellaneous
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="APIRef.html">
    API Reference
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="bibliography.html">
    Bibliography
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ShakingTable/shakingtable.github.io" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="#">
    Usage
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="BuildInstructions.html">
    Build instructions
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="mathBackground.html">
    Mathematical Background
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="hardware.html">
    Hardware
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="functionality.html">
    Functionality
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="microcontroller.html">
    Microcontroller
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="misc.html">
    Miscellaneous
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="APIRef.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="bibliography.html">
    Bibliography
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ShakingTable/shakingtable.github.io" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"></div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Usage</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Link to this heading">#</a></h1>
<section id="installation">
<h2><strong>Installation</strong><a class="headerlink" href="#installation" title="Link to this heading">#</a></h2>
<section id="microcontroller-firmware">
<h3><strong>Microcontroller Firmware</strong><a class="headerlink" href="#microcontroller-firmware" title="Link to this heading">#</a></h3>
<p>The easiest way of uploading and managing the controller firmware is through <a class="reference external" href="https://code.visualstudio.com/">Visual Studio Code</a> and the <a class="reference external" href="https://platformio.org/">PlatformIO extension</a>. For more details see <a class="reference internal" href="microcontroller.html#ucinstallation"><span class="std std-ref">Firmware installation</span></a>.</p>
</section>
<section id="matlab-framework">
<h3><strong>MATLAB-Framework</strong><a class="headerlink" href="#matlab-framework" title="Link to this heading">#</a></h3>
<p>No installation needed, clone the repository and open the code!</p>
</section>
</section>
<section id="matlab">
<h2><strong>MATLAB</strong><a class="headerlink" href="#matlab" title="Link to this heading">#</a></h2>
<p>The current way of controlling the motor is implemented in the proprietary software-package MATLAB. We opted for this based on convenience, but the basic concepts we used should be translatable to other programming languages. In the following we will explain some of the functions inside the current implementation to give a better overview over the framework.</p>
<p>The code is made up mostly of functions with specific functionalities:</p>
<blockquote>
<div><ul class="simple">
<li><p>Creating time-position signals for some specific situations (Fixed frequencies, random frequencies, signals based on power spectrums, earthquake records…) (<code class="docutils literal notranslate"><span class="pre">Methods</span></code>}-folder)</p></li>
<li><p>Helping to create these signals</p></li>
<li><p>Setting up and communicating with the serial interface of the motor</p></li>
<li><p>Analyzing the data</p></li>
</ul>
</div></blockquote>
<p>There are also currently two classes (<code class="docutils literal notranslate"><span class="pre">Classes</span></code>-folder), one to specify the used simulation method for the time-position signal (<code class="docutils literal notranslate"><span class="pre">MethodEnum.m</span></code>) and one class working as a container to organize all the data (<code class="docutils literal notranslate"><span class="pre">ShakingData.m</span></code>). The latter is something like the back-bone of the implementation, since all information is saved into that format, so most of the functions use this container to either manipulate or add to the recorded data.</p>
<section id="overview">
<h3><strong>Overview</strong><a class="headerlink" href="#overview" title="Link to this heading">#</a></h3>
<p>Lets look at one specific example. We want to the motor to shake for 10 seconds with two frequencies of 1 Hz and 2 Hz with amplitudes of 5 mm and 1 mm respectively. The starting point here is the file <code class="docutils literal notranslate"><span class="pre">MainCreateSimulation.m</span></code> in the main folder. After the initialization we arrive at the following lines</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">usedMethod</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">MethodEnum</span><span class="p">.</span><span class="n">FixedHarmonic</span><span class="p">;</span>
<span class="n">stepsPerSecond</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="n">maxT</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</pre></div>
</div>
<p>which means that the simulation of our signal will use the <code class="docutils literal notranslate"><span class="pre">FixedHarmonic</span></code>-method to give us a signal discretized with a time step of <span class="math notranslate nohighlight">\(\frac{1}{100}~\text{s}\)</span> simulated for 10 s. Afterwards in the <code class="docutils literal notranslate"><span class="pre">switch-case</span></code> instruction the method corresponding to the chosen <code class="docutils literal notranslate"><span class="pre">MethodEnum</span></code> will be called.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="n">MethodEnum</span><span class="p">.</span><span class="n">FixedHarmonic</span>
<span class="c">%simulateFixedHarmonic, inpt: omega [Hz], amp [mm], maxT [s]</span>
<span class="p">[</span><span class="n">pos</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SimulateFixedHarmonic</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">maxT</span><span class="p">,</span><span class="s">&#39;nStepsPerSecond&#39;</span><span class="p">,</span><span class="n">stepsPerSecond</span><span class="p">);</span>
<span class="n">currentSimulationData</span><span class="p">.</span><span class="n">inputSignal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">t</span><span class="o">&#39;</span><span class="p">,</span><span class="n">pos</span><span class="o">&#39;</span><span class="p">];</span>
<span class="n">currentSimulationData</span><span class="p">.</span><span class="n">motorRate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">stepsPerSecond</span><span class="p">;</span>
</pre></div>
</div>
<p>We get a position-array <code class="docutils literal notranslate"><span class="pre">pos</span></code>, a time-array <code class="docutils literal notranslate"><span class="pre">t</span></code> and the name corresponding to the method we used, which we can save to the container <code class="docutils literal notranslate"><span class="pre">currentSimulationData</span></code> for later use.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is critical to set the <code class="docutils literal notranslate"><span class="pre">.motorRate</span></code> property here as having different values in the <code class="docutils literal notranslate"><span class="pre">pos</span></code>-array and the motor software might lead to unexpected behavior!</p>
</div>
<p>This creates the following signal:</p>
<figure class="align-default" id="id1">
<img alt="_images/Pos_12Hz.png" src="_images/Pos_12Hz.png" />
<figcaption>
<p><span class="caption-text">Time-position diagram for signal for frequencies of 1 and 2 Hz.</span><a class="headerlink" href="#id1" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>This would be fine to send to the motor, but we also implemented a function inside the <code class="docutils literal notranslate"><span class="pre">ShakingData</span></code>-class to calculate velocity and acceleration to make sure the table does not operate in unsafe conditions. The method is called <code class="docutils literal notranslate"><span class="pre">ShakingData.Setup</span></code> and calculates velocity and acceleration based on finite difference-calculations of the time-position signal.</p>
<figure class="align-default" id="id2">
<img alt="_images/Pos_Vel_Acc_12Hz.png" src="_images/Pos_Vel_Acc_12Hz.png" />
<figcaption>
<p><span class="caption-text">Time-position, time-velocity and time-acceleration diagrams for signal for frequencies of 1 and  2 Hz.</span><a class="headerlink" href="#id2" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Note that the velocity diagram starts at a value of 40 mm/s which translates to an incredibly high acceleration. We can also filter the start and end positions of the table, such that it starts and ends more slowly. We implemented the <code class="docutils literal notranslate"><span class="pre">FilterMotorInput</span></code>-function for this purpose:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">currentSimulationData</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">FilterMotorInput</span><span class="p">(</span><span class="n">currentSimulationData</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>The 1 in the end is the time for speed-up and ramp-down of the motor, so in this case it will take 1 second to reach the desired signal and 1 second in the end to calm down. Mathematically this is done by multiplying a linear function based on the distances to the edges on top of the signal. This leads to the following positions, velocities and accelerations:</p>
<figure class="align-default" id="id3">
<img alt="_images/Filtered_Pos_Vel_Acc_12Hz.png" src="_images/Filtered_Pos_Vel_Acc_12Hz.png" />
<figcaption>
<p><span class="caption-text">Filtered Time-position, time-velocity and time-acceleration diagrams for signal for frequencies of 1 and 2 Hz.</span><a class="headerlink" href="#id3" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Now we can send this data to the motor, but we first have to compile the time-position data to Marv-Code. For that we have the <code class="docutils literal notranslate"><span class="pre">WriteMarvCode</span></code>-function, which again takes as argument the <code class="docutils literal notranslate"><span class="pre">ShakingData</span></code>-container. Internally this function translates the given positions into a set of strings that can be sent to the motor via serial communication. The resulting Marv-Code is stored in the <code class="docutils literal notranslate"><span class="pre">ShakingData</span></code>-container (For more details about Marv-Code see <a class="reference internal" href="#marvcode"><span class="std std-ref">the Marv-Code section</span></a>). In MATLAB we also need to create a <code class="docutils literal notranslate"><span class="pre">serialport</span></code>-Object which handles the serial communication. For that we need the serial port of our micro-controller (ESP32) and a baud-rate (The rate in which the communication is happening):</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">dev</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">serialport</span><span class="p">(</span><span class="o">&lt;</span><span class="nb">COM</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">115200</span><span class="p">);</span>
</pre></div>
</div>
<p>where the first argument &lt;COM&gt; is the serial port of the controller, for us this was mostly “COM3” since we used Windows.
In Windows, the port can be found in the device manager, Linux users can find this with <code class="docutils literal notranslate"><span class="pre">$dmesg</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">tty</span></code>. We can now send the code to the controller:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">SendDataToMotor</span><span class="p">(</span><span class="n">currentSimulationData</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
</pre></div>
</div>
<p>which (if successful) should also print information from the motor to the console. Then the shaking can commence:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">SendInstructionToUSB</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="s">&#39;start&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>The 1 is needed since we can also send multiple instructions to the controller at the same time, after each one the controller will (hopefully) reply with ‘OK’. To catch all these replies we need to send the number of instructions. Maybe we should automate this. The controller will now work through all the saved instructions.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is no delay after sending the instruction, so make sure that the table is safe to operate before sending the command!</p>
</div>
<p>The shaking can be stopped anytime by executing</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">SendInstructionToUSB</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="s">&#39;stop&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>It is also of course possible to cut the motor power in emergency situations (although be careful that this might damage motor, driver or controller). The current state of the motor can also be shown by executing</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">SendInstructionToUSB</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="s">&#39;info&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="motor-control">
<h3><strong>Motor control</strong><a class="headerlink" href="#motor-control" title="Link to this heading">#</a></h3>
<p>The earlier versions of the motor control software used G-Code, which is also found in 3D-printers. The motivation behind this was that the standard already existed and open-source software could be used to communicate with the motor. However we found that there was some overhead in the implementation of G-Code itself (such as acceleration limits), which interfered with the accuracy of the timings, so a new standard was needed. We named it Marv-Code, after its inventor Marvin Banse. An overview of the syntax is given in <a class="reference internal" href="#marvcode"><span class="std std-ref">the Marv-Code section</span></a>.</p>
<p>One thing to note here is that there are currently no specific safety features implemented. The table has no way of knowing about its initial position or about the limits, since there are no sensors such as limit switches to inform about that. It is also entirely possible that the table behaves in unexpected ways if there are configuration issues, i.e. different settings for time stepping in the motor itself and in the signal. The way in which the controller software currently works means that safety features (maximum position, acceleration, velocity…) have to be implemented BEFORE uploading the code to the controller. This allows for more flexibility in the motor controls. We are working on implementing at least limit switches, s.t. the motor can auto-center itself and also know when it would slide off the rails.</p>
</section>
<section id="motor-setup">
<h3><strong>Motor setup</strong><a class="headerlink" href="#motor-setup" title="Link to this heading">#</a></h3>
<p>An important property of motor and the table is the amount of steps the motor has to do for one millimeter of table displacement. In Marv-Code this is set externally by the <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">spmm</span></code>-command, but it is a property of the physical setup of the table itself.</p>
<p>In our case, we use a belt-gear driven system with a NEMA23 stepper motor. For one full step (not regarding micro-stepping) the motor does 1.8° of rotation. In other words, for one full rotation the motor needs</p>
<div class="math notranslate nohighlight">
\[\frac{360}{1.8} = 200\]</div>
<p>steps. Furthermore, we use GT2-belts and gears, both have teeth that are 2 mm apart. The used gear has 20 teeth, so one full rotation will move the table by <span class="math notranslate nohighlight">\(20\cdot2~\text{mm} = 40~\text{mm}\)</span>. Consequently, 40 mm of travel corresponds to 200 steps from the motor, so we have</p>
<div class="math notranslate nohighlight">
\[\frac{200~\text{steps}}{40~\text{mm}} = 5 \frac{\text{steps}}{\text{mm}}\]</div>
<p>This also translates to a resolution of 0.2 mm in the position, which is not very good. Thankfully, most stepper motors are able to use micro-stepping to increase the resolution. A micro-stepping of 1/4 (so 800 steps per revolution) for example would increase the resolution to  0.05 mm. Keep in mind that the higher the steps per second, the faster the motor control software has to work. At some point it cannot keep up anymore, so increasing the microstepping to high values is not recommended. There is also a trade-off between microstepping and the available torque in the motor. Basically, higher resolutions in the motor lead to less torque and can also lead to the motor losing steps, which decreases the accuracy. All these calculations and setup decisions depend on the exact table setup, so give it some thought.</p>
<p>This is a small calibration code for steps/mm setting. This code aims at moving the table 10mm in one direction. Please note that after using this code once, e.g. with +10, -10 should be used, otherwise the table will not move.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">SendInstructionToUSB</span><span class="p">(</span><span class="n">dev</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s">&#39;reset&#39;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">);</span>
<span class="n">SendInstructionToUSB</span><span class="p">(</span><span class="n">dev</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s">&#39;set spmm [SPMM]&#39;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">);</span>
<span class="n">SendInstructionToUSB</span><span class="p">(</span><span class="n">dev</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s">&#39;set rate 0.1&#39;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">);</span>
<span class="n">SendInstructionToUSB</span><span class="p">(</span><span class="n">dev</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s">&#39;add +- 10&#39;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">);</span>
<span class="n">SendInstructionToUSB</span><span class="p">(</span><span class="n">dev</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s">&#39;start&#39;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">);</span>
</pre></div>
</div>
<p>After running this code a visual inspection on how much the table actually moved should be performed. If the initial setting of <code class="docutils literal notranslate"><span class="pre">[SPMM]</span></code> was not correct, this needs to be adjusted.</p>
</section>
<section id="marv-code">
<h3><strong>Marv-Code</strong><a class="headerlink" href="#marv-code" title="Link to this heading">#</a></h3>
<div class="pst-scrollable-table-container"><span id="marvcode"></span><table class="table" id="id4">
<caption><span class="caption-text">Title</span><a class="headerlink" href="#id4" title="Link to this table">#</a></caption>
<colgroup>
<col style="width: 50.0%" />
<col style="width: 50.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">start</span></code></p></td>
<td><p>Starts motor movement with previously defined positions at the previously set rate</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">stop</span></code></p></td>
<td><p>Immediately stops motor movement</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">info</span></code></p></td>
<td><p>Writes out information about machine state to serial, <code class="docutils literal notranslate"><span class="pre">OK:</span> <span class="pre">Info:</span> <span class="pre">state:</span> <span class="pre">READY,</span> <span class="pre">mode</span> <span class="pre">POSITION,</span> <span class="pre">command</span> <span class="pre">25</span> <span class="pre">of</span> <span class="pre">25,</span> <span class="pre">rate:</span> <span class="pre">20hz,</span> <span class="pre">spmm:</span> <span class="pre">10</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">rate</span> <span class="pre">nnn.nnn</span></code></p></td>
<td><p>set the amout of positions to handle in one second</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">spmm</span></code></p></td>
<td><p>specifies how many steps the motor has to drive to move the carriage one millimeter</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">add</span> <span class="pre">nnn.nnn</span></code></p></td>
<td><p>adds a position at the end of list</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">reset</span></code></p></td>
<td><p>resets all positions from memory</p></td>
</tr>
</tbody>
</table>
</div>
<p>The basic principle behind Marv-Code is that the motor is given a rate (instructions per second) and a list of positions so it can calculate the stepping rate needed to reach the given positions for each time step in the simulation. The stepper motor is only able to move in discrete steps, it is therefore necessary for the controller to calculate the exact rate from the given rate and the desired positions.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">Marv-Code example</span><a class="headerlink" href="#id5" title="Link to this code">#</a></div>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nb">clear</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="nb">memory</span>
<span class="linenos"> 2</span><span class="w">     </span><span class="nb">reset</span>
<span class="linenos"> 3</span><span class="w">     </span>#<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="n">steps</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">mm</span>
<span class="linenos"> 4</span><span class="w">     </span><span class="nb">set</span><span class="w"> </span><span class="n">spmm</span><span class="w"> </span><span class="mi">10</span>
<span class="linenos"> 5</span><span class="w">     </span>#<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="nb">second</span>
<span class="linenos"> 6</span><span class="w">     </span><span class="nb">set</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="mf">2.5</span>
<span class="linenos"> 7</span><span class="w">     </span><span class="nb">set</span><span class="w"> </span><span class="nb">mode</span><span class="w"> </span><span class="n">pos</span>
<span class="linenos"> 8</span><span class="w">     </span><span class="nb">add</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>#<span class="nb">add</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="w"> </span><span class="n">mm</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="w">     </span><span class="nb">add</span><span class="w"> </span><span class="mi">16</span>
<span class="linenos">10</span><span class="w">     </span><span class="nb">add</span><span class="w"> </span><span class="mi">20</span>
<span class="linenos">11</span><span class="w">     </span><span class="nb">add</span><span class="w"> </span><span class="mi">21</span>
<span class="linenos">12</span><span class="w">     </span><span class="nb">add</span><span class="w"> </span><span class="mi">18</span>
<span class="linenos">13</span><span class="w">     </span><span class="nb">add</span><span class="w"> </span><span class="mf">0.5</span>
<span class="linenos">14</span><span class="w">     </span><span class="nb">add</span><span class="w"> </span><span class="o">-</span><span class="mi">20</span>
<span class="linenos">15</span><span class="w">     </span><span class="nb">add</span><span class="w"> </span><span class="o">-</span><span class="mi">22</span>
<span class="linenos">16</span><span class="w">     </span><span class="nb">add</span><span class="w"> </span><span class="o">-</span><span class="mi">20</span>
<span class="linenos">17</span><span class="w">     </span><span class="nb">add</span><span class="w"> </span><span class="o">-</span><span class="mi">10</span>
<span class="linenos">18</span><span class="w">     </span><span class="nb">add</span><span class="w"> </span><span class="mi">0</span>
<span class="linenos">19</span><span class="w">     </span><span class="nb">start</span><span class="w"> </span>#<span class="w"> </span><span class="nb">start</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">experiment</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Welcome to Namazu’s documentation!</p>
      </div>
    </a>
    <a class="right-next"
       href="BuildInstructions.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Build instructions</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installation"><strong>Installation</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#microcontroller-firmware"><strong>Microcontroller Firmware</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#matlab-framework"><strong>MATLAB-Framework</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#matlab"><strong>MATLAB</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#overview"><strong>Overview</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#motor-control"><strong>Motor control</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#motor-setup"><strong>Motor setup</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#marv-code"><strong>Marv-Code</strong></a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="_sources/usage.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Bittner, Grashorn, Banse.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.0.2.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>